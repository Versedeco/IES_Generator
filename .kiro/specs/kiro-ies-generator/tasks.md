# 任务列表

## 项目：Kiro IES Generator

本文档定义了实现 Kiro IES Generator Blender 插件的所有开发任务。任务按模块组织，包括开发任务、测试任务和文档任务。

---

## 1. 项目设置与基础架构

### 1.1 创建项目结构
- [ ] 创建项目根目录 `kiro_ies_generator/`
- [ ] 创建模块文件：`scene_validator.py`, `sampler.py`, `ies_generator.py`, `output_manager.py`
- [ ] 创建插件主文件：`__init__.py`（Blender 插件入口）
- [ ] 创建测试目录 `tests/`
- [ ] 创建文档目录 `docs/`

### 1.2 配置开发环境
- [ ] 编写 `README.md`（项目说明、安装指南）
- [ ] 创建 `.gitignore`（排除 Blender 临时文件、Python 缓存）
- [ ] 配置 Blender 插件元数据（`bl_info`）
- [ ] 设置 Python 导入路径和模块依赖

### 1.3 定义数据结构
- [ ] 实现 `SamplingConfig` 数据类
- [ ] 实现 `SceneValidation` 数据类
- [ ] 实现 `SamplingResult` 数据类
- [ ] 实现 `PhotometricData` 数据类
- [ ] 实现错误类：`KiroError`, `SceneValidationError`, `SamplingError`, `CalibrationError`

---

## 2. 场景验证器模块（scene_validator.py）

### 2.1 实现场景验证核心功能
- [ ] 实现 `validate_scene()` - 验证当前场景配置
- [ ] 实现 `get_light_sources()` - 获取场景中所有光源
- [ ] 实现 `validate_light_source()` - 验证光源类型（点光源/面光源）
- [ ] 实现 `check_render_engine()` - 检查渲染引擎是否为 Cycles
- [ ] 实现 `get_light_properties()` - 获取光源属性（位置、强度、类型）
- [ ] 实现 `calculate_photometric_center()` - 计算多个光源的光度中心（几何中心）
- [ ] 实现 `get_fixture_origin()` - 获取灯具模型的原点位置

### 2.2 错误处理与验证
- [ ] 实现场景无光源的错误检测
- [ ] 实现多光源场景的支持（允许多选）
- [ ] 实现渲染引擎不正确的警告
- [ ] 实现光源类型不支持的错误提示
- [ ] 添加详细的错误消息和修正建议
- [ ] 实现光度中心计算的验证

### 2.3 单元测试
- [ ] 测试单光源场景验证
- [ ] 测试多光源场景验证
- [ ] 测试无光源场景错误检测
- [ ] 测试点光源和面光源识别
- [ ] 测试渲染引擎检测

### 2.4 人工测试
- [ ] 执行测试阶段 1：场景准备验证
  - [ ] 测试用例 1.1：单光源场景
  - [ ] 测试用例 1.2：多光源场景
  - [ ] 测试用例 1.3：错误场景检测

---

## 3. 采样器模块（sampler.py）

### 3.1 实现球面坐标计算
- [ ] 实现 `spherical_to_cartesian()` - 球面坐标转笛卡尔坐标
- [ ] 实现 `calculate_sampling_points()` - 计算所有采样点位置和角度
- [ ] 实现坐标系转换（Blender Z-up ↔ IES Y-up）
- [ ] 添加球面坐标计算的数学注释

### 3.2 实现虚拟传感器功能
- [ ] 实现 `create_virtual_sensor()` - 创建虚拟相机
- [ ] 实现相机朝向计算（Track To 约束或手动旋转）
- [ ] 实现相机清理逻辑（删除临时对象）
- [ ] 实现相机复用机制（性能优化）

### 3.3 实现渲染功能
- [ ] 实现 `render_at_sensor()` - 在传感器位置执行 Cycles 渲染
- [ ] 实现亮度值提取（从渲染图像中心像素）
- [ ] 配置 Cycles 渲染参数（采样数、去噪）
- [ ] 实现渲染失败的错误恢复

### 3.4 实现球面采样主流程
- [ ] 实现 `collect_spherical_data()` - 完整的球面采样流程
- [ ] 实现进度回调机制
- [ ] 实现取消操作支持
- [ ] 实现数据存储到 NumPy 数组
- [ ] 实现采样点失败的容错处理

### 3.5 性能优化
- [ ] 预计算三角函数值（sin, cos）
- [ ] 实现相机对象复用
- [ ] 优化 NumPy 数组操作
- [ ] 添加采样时间估算功能

### 3.6 单元测试
- [ ] 测试球面坐标转换精度
- [ ] 测试采样点数量计算
- [ ] 测试虚拟传感器创建和清理
- [ ] 测试渲染失败恢复
- [ ] 测试进度回调功能

### 3.7 人工测试
- [ ] 执行测试阶段 2：球面采样功能
  - [ ] 测试用例 2.1：简单球体测试
  - [ ] 测试用例 2.2：半球遮挡测试
  - [ ] 测试用例 2.3：取消操作测试

---

## 4. IES 生成器模块（ies_generator.py）

### 4.1 实现单位校准功能
- [ ] 实现 `calibrate_to_candela()` - 将 Blender 单位转换为坎德拉
- [ ] 实现校准因子计算（基于总流明和立体角）
- [ ] 实现校准参数验证（流明值 > 0）
- [ ] 添加校准算法的数学注释

### 4.2 实现 IES 文件格式化
- [ ] 实现 `generate_ies_header()` - 生成 IESNA LM-63-2002 文件头
- [ ] 实现 `format_ies_data()` - 格式化角度和坎德拉数据
- [ ] 实现角度数据排序（升序）
- [ ] 实现数值格式化（精度、对齐）

### 4.3 实现坐标系转换
- [ ] 实现 `blender_to_ies_coordinates()` - Blender Z-up 转 IES Y-up
- [ ] 验证坐标转换的几何不变性
- [ ] 添加坐标系转换的注释和图示

### 4.4 实现 IES 文件生成
- [ ] 实现 `generate_ies_file()` - 从采样结果生成完整 IES 文件
- [ ] 实现 `validate_ies_compliance()` - 验证 IES 文件合规性
- [ ] 实现 IES 文件内容验证

### 4.5 单元测试
- [ ] 测试单位校准一致性
- [ ] 测试校准参数验证
- [ ] 测试 IES 文件头格式
- [ ] 测试角度数据排序
- [ ] 测试坐标系转换往返

### 4.6 人工测试
- [ ] 执行测试阶段 3：IES 文件生成
  - [ ] 测试用例 3.1：IES 文件格式验证
  - [ ] 测试用例 3.2：IES 文件导入测试
  - [ ] 测试用例 3.3：第三方工具验证

---

## 5. 输出管理器模块（output_manager.py）

### 5.1 实现文件写入功能
- [ ] 实现 `write_ies_file()` - 写入 IES 文件到磁盘
- [ ] 实现 `write_metadata_file()` - 写入 JSON 元数据文件到磁盘
- [ ] 实现 `ensure_directory_exists()` - 创建必要的目录
- [ ] 实现文件覆盖确认逻辑
- [ ] 实现文件写入错误处理

### 5.2 实现元数据生成功能
- [ ] 实现 `generate_metadata()` - 生成完整的元数据字典
- [ ] 实现光度中心信息的格式化（世界坐标和相对坐标）
- [ ] 实现光源信息列表的生成
- [ ] 实现使用说明的生成（针对不同渲染引擎）
- [ ] 实现元数据的 JSON 序列化

### 5.3 实现文件验证功能
- [ ] 实现 `verify_file_written()` - 验证文件成功写入
- [ ] 实现 `get_default_output_path()` - 生成默认输出路径
- [ ] 实现文件大小和可读性检查
- [ ] 实现元数据文件的验证

### 5.4 单元测试
- [ ] 测试 IES 文件写入成功
- [ ] 测试元数据文件写入成功
- [ ] 测试目录自动创建
- [ ] 测试文件覆盖保护
- [ ] 测试文件写入错误处理
- [ ] 测试默认路径生成
- [ ] 测试元数据内容正确性

---

## 6. Blender 插件 UI（__init__.py）

### 6.1 实现插件注册
- [ ] 定义 `bl_info` 元数据
- [ ] 实现 `register()` 函数
- [ ] 实现 `unregister()` 函数
- [ ] 注册所有 UI 类和操作符

### 6.2 实现 UI 面板
- [ ] 创建侧边栏面板类（`VIEW3D_PT_ies_generator`）
- [ ] 添加光源选择界面（支持多选）
- [ ] 添加光度中心显示区域（世界坐标和相对坐标）
- [ ] 添加复制坐标按钮（复制到剪贴板）
- [ ] 添加总流明值显示
- [ ] 添加采样参数输入（角度间隔、采样数、测量距离）
- [ ] 添加输出路径选择
- [ ] 添加"生成 IES"按钮
- [ ] 添加"取消"按钮

### 6.3 实现操作符
- [ ] 创建"生成 IES"操作符（`OBJECT_OT_generate_ies`）
- [ ] 实现操作符的 `execute()` 方法
- [ ] 实现操作符的 `invoke()` 方法（文件选择对话框）
- [ ] 实现操作符的 `modal()` 方法（进度更新）

### 6.4 实现进度反馈
- [ ] 实现进度条显示
- [ ] 实现状态文本更新
- [ ] 实现采样点计数显示
- [ ] 实现时间估算显示
- [ ] 实现取消操作处理

### 6.5 实现参数验证
- [ ] 验证采样参数范围
- [ ] 实时计算采样点总数
- [ ] 实时估算完成时间
- [ ] 显示参数错误提示

### 6.6 UI 测试
- [ ] 测试面板显示
- [ ] 测试参数输入和验证
- [ ] 测试光源多选功能
- [ ] 测试光度中心实时计算和显示
- [ ] 测试坐标复制功能
- [ ] 测试进度显示
- [ ] 测试取消操作

---

## 7. 多光源处理与元数据生成

### 7.1 实现光度中心计算
- [ ] 实现单光源的光度中心获取
- [ ] 实现多光源的几何中心计算
- [ ] 实现相对坐标计算（相对于灯具原点）
- [ ] 实现光度中心的验证和边界检查

### 7.2 实现元数据结构
- [ ] 定义元数据 JSON 格式规范
- [ ] 实现光度中心信息的结构化
- [ ] 实现光源列表信息的结构化
- [ ] 实现使用说明的结构化（UE5、V-Ray、Corona）

### 7.3 实现 UI 集成
- [ ] 在 UI 中显示光度中心（世界坐标）
- [ ] 在 UI 中显示光度中心（相对坐标）
- [ ] 实现复制世界坐标到剪贴板
- [ ] 实现复制相对坐标到剪贴板
- [ ] 实现总流明值的实时计算和显示

### 7.4 单元测试
- [ ] 测试单光源光度中心计算
- [ ] 测试多光源光度中心计算（对称分布）
- [ ] 测试多光源光度中心计算（不对称分布）
- [ ] 测试相对坐标计算
- [ ] 测试元数据 JSON 生成
- [ ] 测试元数据内容完整性

---

## 8. 错误处理与日志

### 8.1 实现错误处理系统
- [ ] 实现错误分类（可恢复、用户错误、致命错误）
- [ ] 实现错误日志格式
- [ ] 实现错误消息本地化（中文）
- [ ] 实现错误恢复建议

### 8.2 实现日志系统
- [ ] 实现日志记录到 Blender 控制台
- [ ] 实现日志级别（INFO、WARNING、ERROR）
- [ ] 实现时间戳和模块名称
- [ ] 实现堆栈跟踪记录

### 8.3 测试错误处理
- [ ] 测试场景验证错误
- [ ] 测试采样错误恢复
- [ ] 测试校准错误检测
- [ ] 测试文件写入错误
- [ ] 测试元数据生成错误

---

## 9. 基于属性的测试

### 8.1 设置测试框架
- [ ] 安装 `hypothesis` 库
- [ ] 配置测试环境
- [ ] 创建测试工具函数

### 8.2 实现属性测试
- [ ] 属性 1：场景光源检测
- [ ] 属性 2：光源类型验证
- [ ] 属性 3：渲染引擎检测
- [ ] 属性 4：采样参数验证
- [ ] 属性 5：采样点数量计算
- [ ] 属性 6：球面坐标距离不变性
- [ ] 属性 7：坐标系转换往返
- [ ] 属性 8：虚拟传感器朝向
- [ ] 属性 9：传感器清理
- [ ] 属性 10：数据存储格式
- [ ] 属性 11：渲染错误恢复
- [ ] 属性 12：数据完整性验证
- [ ] 属性 13：单位校准一致性
- [ ] 属性 14：校准参数验证
- [ ] 属性 15：IES 文件头合规性
- [ ] 属性 16：角度数据排序
- [ ] 属性 17：坎德拉值格式化
- [ ] 属性 18：文件写入验证
- [ ] 属性 19：目录自动创建
- [ ] 属性 20：文件覆盖保护
- [ ] 属性 21：进度报告完整性
- [ ] 属性 22：取消操作安全性
- [ ] 属性 23：错误日志完整性
- [ ] 属性 24：错误恢复建议
- [ ] 属性 25：异常堆栈跟踪

---

## 9. 基准测试

### 9.1 实现球体测试
- [ ] 创建 `tests/test_sphere.py`
- [ ] 创建各向同性光源测试场景
- [ ] 验证所有方向光强相等（±5%）
- [ ] 记录基准数据

### 9.2 实现半球测试
- [ ] 创建 `tests/test_hemisphere.py`
- [ ] 创建半球遮罩测试场景
- [ ] 验证遮挡效果正确
- [ ] 验证光分布符合预期

---

## 10. 集成测试

### 10.1 端到端测试
- [ ] 执行测试阶段 4：完整工作流
  - [ ] 测试用例 4.1：简单灯具完整流程

### 10.2 性能测试
- [ ] 测试预览模式性能（10° 间隔，64 采样）
- [ ] 测试生产模式性能（5° 间隔，256 采样）
- [ ] 验证时间估算准确性
- [ ] 优化性能瓶颈

### 10.3 兼容性测试
- [ ] 测试 Blender 3.6 兼容性
- [ ] 测试 Blender 4.x 兼容性
- [ ] 测试 Windows 平台
- [ ] 测试 Linux 平台（可选）
- [ ] 测试 macOS 平台（可选）

---

## 11. 文档

### 11.1 用户文档
- [ ] 编写用户手册（中文）
  - [ ] 安装指南
  - [ ] 快速开始教程
  - [ ] 场景准备指南
  - [ ] 参数配置说明
  - [ ] 故障排除
- [ ] 创建示例场景文件
- [ ] 录制视频教程（可选）

### 11.2 开发者文档
- [ ] 编写 API 文档
- [ ] 编写架构说明
- [ ] 编写贡献指南
- [ ] 添加代码注释（中文）

### 11.3 示例和教程
- [ ] 创建简单灯具示例
- [ ] 创建灯管示例
- [ ] 创建面板灯示例
- [ ] 创建材质参数参考表

---

## 12. 打包与发布

### 12.1 准备发布
- [ ] 清理代码和注释
- [ ] 运行完整测试套件
- [ ] 更新版本号
- [ ] 编写 CHANGELOG

### 12.2 打包插件
- [ ] 创建插件 ZIP 包
- [ ] 验证插件安装流程
- [ ] 测试插件卸载流程

### 12.3 发布
- [ ] 发布到 GitHub
- [ ] 编写发布说明
- [ ] 创建示例文件下载链接

---

## 任务优先级

### 高优先级（MVP 核心功能）
1. 项目设置与基础架构（任务 1）
2. 场景验证器模块（任务 2）
3. 采样器模块（任务 3）
4. IES 生成器模块（任务 4）
5. 输出管理器模块（任务 5）
6. 基本 UI 实现（任务 6.1-6.3）

### 中优先级（完善功能）
7. 进度反馈和取消操作（任务 6.4）
8. 错误处理与日志（任务 7）
9. 单元测试（任务 2.3, 3.6, 4.5, 5.3）
10. 人工测试（任务 2.4, 3.7, 4.6, 10.1）

### 低优先级（优化和文档）
11. 基于属性的测试（任务 8）
12. 基准测试（任务 9）
13. 性能优化（任务 3.5）
14. 文档（任务 11）
15. 打包与发布（任务 12）

---

## 里程碑

### 里程碑 1：MVP 完成（核心功能可用）
- 完成任务 1-5
- 完成任务 6.1-6.3
- 能够生成基本的 IES 文件

### 里程碑 2：功能完善（用户友好）
- 完成任务 6.4-6.6
- 完成任务 7
- 完成所有单元测试
- 完成人工测试

### 里程碑 3：生产就绪（稳定可靠）
- 完成所有属性测试
- 完成基准测试
- 完成性能优化
- 完成用户文档

### 里程碑 4：正式发布
- 完成所有测试
- 完成所有文档
- 打包并发布

---

## 预估时间

- **里程碑 1（MVP）**：2-3 周
- **里程碑 2（功能完善）**：1-2 周
- **里程碑 3（生产就绪）**：1-2 周
- **里程碑 4（正式发布）**：1 周

**总计**：5-8 周

---

## 注意事项

1. **开发顺序**：按照模块依赖关系开发，先完成底层模块（场景验证、采样器），再完成上层模块（UI）
2. **测试驱动**：每完成一个模块立即编写单元测试，确保质量
3. **人工测试**：在关键里程碑进行人工测试，及早发现问题
4. **代码审查**：定期审查代码质量和注释完整性
5. **文档同步**：开发过程中同步更新文档，避免遗漏
