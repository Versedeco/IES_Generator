# 实施计划：Kiro IES Generator

## 概述

本实施计划将 Kiro IES Generator 的设计分解为可执行的编码任务。实施将采用增量方式，从核心模块开始，逐步构建完整的 MVP 核心脚本（kiro_core.py）。每个任务都包含具体的实现目标和需求引用。

## 任务

- [ ] 1. 项目结构和配置设置
  - 创建项目目录结构
  - 设置 config/materials.json 材质预设文件
  - 创建基础的 Python 包结构（__init__.py）
  - _需求：13.1_

- [ ] 2. 实现输入管理器模块
  - [ ] 2.1 实现 3D 模型导入功能
    - 实现 import_model() 函数，支持 OBJ、FBX、STL 格式
    - 使用 bpy.ops.import_scene 进行文件导入
    - 处理文件不存在和格式不支持的错误
    - _需求：1.1, 1.2, 1.3, 1.4_
  
  - [ ]* 2.2 为模型导入编写属性测试
    - **属性 1：多格式导入一致性**
    - **验证需求：1.1, 1.2, 1.3**
  
  - [ ] 2.3 实现网格验证功能
    - 实现 validate_mesh() 函数
    - 实现 check_mesh_closed() - 检查边界边
    - 实现 check_mesh_manifold() - 检查非流形顶点
    - 实现 check_normals_consistent() - 检查法线方向
    - 返回 ValidationResult 数据类
    - 对开放式灯具，将非封闭状态作为警告而非错误
    - _需求：2.1, 2.2, 2.3, 2.4_
  
  - [ ]* 2.4 为网格验证编写属性测试
    - **属性 2：网格验证完整性**
    - **验证需求：2.1, 2.2, 2.3, 2.4**
    - **属性 3：无效几何检测**
    - **验证需求：1.4, 1.5, 2.2, 2.3**

- [ ] 3. 实现场景构建器模块
  - [ ] 3.1 实现场景初始化和清理
    - 实现 clear_scene() 函数
    - 实现 setup_scene_units() - 设置为公制毫米
    - _需求：3.1, 3.4_
  
  - [ ] 3.2 实现光源创建功能
    - 实现 create_light_source() - 单光源
    - 实现 create_multiple_light_sources() - 多光源（树状灯、多灯珠）
    - 实现 load_light_positions_from_model() - 从模型读取光源位置
    - 设置光源位置、流明值和半径
    - _需求：3.2, 3.3_
  
  - [ ]* 3.3 为光源创建编写属性测试
    - **属性 4：光源位置精度**
    - **验证需求：3.2, 3.3**
    - **属性 3a：多光源配置一致性**
    - **验证需求：3.2, 3.3**
  
  - [ ] 3.4 实现材质系统
    - 实现 load_material_presets() - 从 JSON 加载预设
    - 实现 apply_material() - 创建 Principled BSDF 节点
    - 设置透射、粗糙度、IOR、SSS 参数
    - 强制 SSS 方法为 RANDOM_WALK
    - 实现材质参数验证
    - _需求：3.5, 4.1, 4.2, 4.3, 4.4, 4.5, 13.1, 13.4_
  
  - [ ]* 3.5 为材质系统编写属性测试
    - **属性 5：材质参数应用**
    - **验证需求：3.5, 4.3**
    - **属性 6：材质预设一致性**
    - **验证需求：4.1, 4.2, 13.3**
    - **属性 7：SSS 方法强制**
    - **验证需求：4.4**
    - **属性 8：材质参数验证**
    - **验证需求：4.5, 15.5**
    - **属性 28：材质预设加载往返**
    - **验证需求：13.1, 13.2**
    - **属性 29：预设回退机制**
    - **验证需求：13.4**
    - **属性 30：自定义预设验证**
    - **验证需求：13.5**

- [ ] 4. 检查点 - 验证场景构建
  - 确保所有测试通过，如有问题请询问用户

- [ ] 5. 实现模拟引擎模块
  - [ ] 5.1 实现 Cycles 渲染配置
    - 实现 configure_cycles() 函数
    - 设置渲染引擎为 Cycles
    - 实现 set_sampling() - 配置采样数
    - 实现 enable_denoising() - 配置 OIDN/OptiX
    - 实现 get_render_settings() - 获取预览/生产模式设置
    - 自动为 SSS 材质启用去噪
    - _需求：5.1, 5.2, 5.3, 5.4, 5.5, 15.1, 15.2_
  
  - [ ]* 5.2 为渲染配置编写单元测试
    - 测试预览模式配置（64 采样）
    - 测试生产模式配置（256+ 采样）
    - 测试去噪器配置
    - **属性 9：SSS 自动去噪**
    - **验证需求：5.5**

- [ ] 6. 实现数据采集器模块
  - [ ] 6.1 实现坐标转换功能
    - 实现 spherical_to_cartesian() - 球面到笛卡尔转换
    - 使用 IESNA LM-63 C-Plane 坐标系
    - 处理 Blender Z-up 坐标系
    - _需求：6.1, 6.2, 14.1_
  
  - [ ]* 6.2 为坐标转换编写属性测试
    - **属性 10：球面坐标计算**
    - **验证需求：6.1, 6.5**
    - **属性 11：坐标系转换往返**
    - **验证需求：6.2, 14.2**
    - **属性 31：坐标系约定一致性**
    - **验证需求：14.1, 14.3**
  
  - [ ] 6.3 实现球面采样算法
    - 实现 calculate_sensor_positions() - 计算采样点
    - 根据角度间隔生成 theta（0-180°）和 phi（0-360°）
    - 支持预览模式（10°）和生产模式（5°）
    - 返回传感器位置的 NumPy 数组
    - _需求：6.3, 6.4, 6.5_
  
  - [ ] 6.4 实现渲染和数据采集
    - 实现 render_at_position() - 在指定位置渲染
    - 设置相机位置和朝向（朝向光源）
    - 执行 Cycles 渲染
    - 从渲染输出提取中心像素亮度
    - 实现错误恢复（渲染失败时继续）
    - _需求：7.1, 7.2, 7.4_
  
  - [ ] 6.5 实现完整采样循环
    - 实现 collect_spherical_data() - 执行完整球面采样
    - 遍历所有采样点并渲染
    - 存储数据到 NumPy 数组 (N_theta, N_phi)
    - 实现进度报告
    - _需求：7.3, 7.5, 12.1, 12.2_
  
  - [ ]* 6.6 为数据采集编写属性测试
    - **属性 13：数据存储格式**
    - **验证需求：7.3, 7.5**
    - **属性 14：渲染错误恢复**
    - **验证需求：7.4**

- [ ] 7. 检查点 - 验证数据采集
  - 确保所有测试通过，如有问题请询问用户

- [ ] 8. 实现 IES 格式化器模块
  - [ ] 8.1 实现单位校准功能
    - 实现 calibrate_to_candela() - Blender 单位转换为坎德拉
    - 使用光通量和距离计算校准因子
    - 对所有数据点应用一致的转换
    - 实现校准参数验证
    - _需求：8.1, 8.2, 8.3, 8.4_
  
  - [ ]* 8.2 为单位校准编写属性测试
    - **属性 15：单位校准一致性**
    - **验证需求：8.1, 8.2, 8.4**
    - **属性 16：校准参数验证**
    - **验证需求：8.3**
  
  - [ ] 8.3 实现 IES 文件生成
    - 实现 generate_ies_header() - 生成 LM-63-2002 文件头
    - 实现 format_ies_data() - 格式化角度和坎德拉数据
    - 确保角度以升序输出
    - 实现坐标系转换（Z-up 到 Y-up）
    - 格式化坎德拉值符合规范
    - _需求：9.1, 9.2, 9.3, 9.4, 14.2_
  
  - [ ] 8.4 实现 IES 验证功能
    - 实现 validate_ies_compliance() - 验证 LM-63-2002 合规性
    - 检查文件头必需字段
    - 验证数据格式
    - _需求：9.5_
  
  - [ ]* 8.5 为 IES 格式化编写属性测试
    - **属性 17：IES 文件头合规性**
    - **验证需求：9.1**
    - **属性 18：角度数据排序**
    - **验证需求：9.2, 9.3**
    - **属性 19：IES 格式验证往返**
    - **验证需求：9.5**
    - **属性 20：坎德拉值格式化**
    - **验证需求：9.4**
    - **属性 12：坐标系几何不变性**
    - **验证需求：14.4**

- [ ] 9. 实现输出管理器模块
  - [ ] 9.1 实现文件输出功能
    - 实现 ensure_directory_exists() - 创建必要目录
    - 实现 write_ies_file() - 写入 IES 文件
    - 处理文件已存在的情况
    - 实现 verify_file_written() - 验证文件写入
    - 实现错误处理和报告
    - _需求：10.1, 10.2, 10.3, 10.4, 10.5_
  
  - [ ]* 9.2 为文件输出编写属性测试
    - **属性 21：文件写入验证**
    - **验证需求：10.1, 10.5**
    - **属性 22：目录自动创建**
    - **验证需求：10.2**
    - **属性 23：文件写入错误处理**
    - **验证需求：10.4**

- [ ] 10. 实现错误处理和日志系统
  - [ ] 10.1 实现错误类层次结构
    - 创建 KiroError 基类
    - 创建 ValidationError、RenderError 等子类
    - 包含时间戳、模块名称、可恢复标志
    - _需求：11.1, 11.2, 11.3_
  
  - [ ] 10.2 实现日志和进度报告
    - 实现错误日志记录（时间戳、模块、消息）
    - 实现进度报告功能
    - 报告阶段完成和经过时间
    - 实现异常堆栈跟踪记录
    - _需求：11.1, 11.5, 12.1, 12.3, 12.5_
  
  - [ ]* 10.3 为错误处理编写属性测试
    - **属性 24：错误日志完整性**
    - **验证需求：11.1**
    - **属性 25：可恢复错误建议**
    - **验证需求：11.2**
    - **属性 26：异常堆栈跟踪**
    - **验证需求：11.5**
    - **属性 27：进度报告完整性**
    - **验证需求：12.3**

- [ ] 11. 实现核心脚本（kiro_core.py）
  - [ ] 11.1 创建主工作流函数
    - 实现 main() 函数，整合所有模块
    - 实现命令行参数解析（argparse）
    - 参数：--input（模型路径）、--output（IES 路径）、--lumens、--material、--mode
    - 实现完整的数据流：导入 → 场景构建 → 模拟 → 采集 → 格式化 → 输出
    - _需求：所有需求_
  
  - [ ] 11.2 实现资源管理
    - 使用上下文管理器确保资源清理
    - 实现优雅的错误处理和退出
    - _需求：11.3_
  
  - [ ]* 11.3 编写端到端集成测试
    - 测试完整工作流（简单球体模型）
    - 测试多光源灯具
    - 测试开放式灯具（非封闭网格）
    - 测试错误恢复场景

- [ ] 12. 检查点 - 验证核心脚本
  - 确保所有测试通过，如有问题请询问用户

- [ ] 13. 实现基准测试
  - [ ] 13.1 创建球体基准测试（test_sphere.py）
    - 创建程序化球体网格
    - 应用各向同性材质
    - 验证所有方向光强度相等（容差范围内）
    - 用于校准基线
  
  - [ ] 13.2 创建遮挡基准测试（test_occlusion.py）
    - 创建半球遮罩模型
    - 验证一半球面光强为零
    - 验证另一半球面光强均匀
    - 验证几何遮挡正确性
  
  - [ ] 13.3 创建校准基准测试（test_calibration.py）
    - 使用已知流明值的光源
    - 验证总坎德拉值与流明值的关系
    - 验证单位转换准确性

- [ ] 14. 文档和使用示例
  - [ ] 14.1 创建 README.md
    - 项目概述和功能
    - 安装说明（Blender 版本要求）
    - 使用示例（命令行）
    - 材质预设说明
  
  - [ ] 14.2 创建示例脚本
    - 创建简单灯具示例
    - 创建多光源灯具示例
    - 创建自定义材质示例

- [ ] 15. 最终验证和优化
  - [ ] 15.1 运行完整测试套件
    - 运行所有单元测试
    - 运行所有属性测试（每个 100+ 次迭代）
    - 运行所有基准测试
    - 验证测试覆盖率 > 80%
  
  - [ ] 15.2 性能优化
    - 分析渲染性能
    - 优化 NumPy 数组操作
    - 验证预览模式时间（5-10 分钟）
    - 验证生产模式时间（20-60 分钟）
  
  - [ ] 15.3 最终代码审查
    - 检查所有函数都有中文 docstring
    - 检查命名约定一致性
    - 检查错误处理完整性
    - 验证所有需求都已实现

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号以确保可追溯性
- 检查点任务确保增量验证和用户反馈
- 属性测试使用 Python 的 `hypothesis` 库，每个测试至少 100 次迭代
- 所有代码必须包含中文注释和 docstring
- 核心脚本（kiro_core.py）是 Phase 1 的交付物，插件（kiro_addon.py）留待 Phase 2
