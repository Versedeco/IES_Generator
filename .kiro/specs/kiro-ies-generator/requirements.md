# 需求文档

## 简介

Kiro IES Generator 是一个 Blender Python 插件，用于从用户手动准备的灯具场景生成符合 IESNA LM-63 标准的光度学文件（.ies）。该插件利用 Cycles 物理渲染引擎的光线追踪能力，通过球面采样测量光强分布，生成可用于渲染引擎的 IES 文件。

## 最终交付物

### 产品形态

**Kiro IES Generator Blender 插件** - 一个可直接安装到 Blender 3.6+ / 4.x 的 Python 插件（.zip 格式）

### 核心功能

1. **图形化用户界面**
   - 集成到 Blender 3D 视图侧边栏
   - 直观的参数配置面板
   - 实时进度显示和状态反馈
   - 支持取消操作

2. **场景验证**
   - 自动检测光源和渲染引擎
   - 智能提示配置错误
   - 支持点光源和面光源

3. **球面采样**
   - 基于 IESNA LM-63 C-Plane 标准
   - 可配置的采样精度（预览/生产模式）
   - 使用 Cycles 物理渲染引擎
   - 自动处理多次反射和次表面散射

4. **IES 文件生成**
   - 符合 IESNA LM-63-2002 标准
   - 自动单位校准（流明 → 坎德拉）
   - 坐标系转换（Blender Z-up → IES Y-up）
   - 文件格式验证

### 支持的灯具类型

**按灯具结构分类**：
- ✅ **封闭式灯具**：完全封闭的灯罩（球形吊灯、筒灯、台灯）
- ✅ **半封闭式灯具**：带内部支撑结构的灯具（工业吊灯、装饰灯）
- ✅ **开放式灯具**：无灯罩或部分开放（树状灯、多灯珠灯具、射灯）

**按光源类型分类**：
- ✅ **点光源**：单个 LED 芯片、小型灯珠、球形灯泡
- ✅ **面光源**：灯管、LED 灯带、发光面板、灯片

**组合支持**：
- 任何灯具结构都可以使用点光源或面光源
- 支持单光源和多光源配置
- 插件自动处理灯具对光源的遮挡和材质散射效果

### 性能指标

性能高度依赖于硬件配置。以下时间基于推荐配置（NVIDIA RTX 3080 GPU）：

**GPU 渲染（推荐）**：
- **预览模式**：2-5 分钟（角度间隔 10°，采样数 64）
- **生产模式**：20-40 分钟（角度间隔 5°，采样数 256）

**CPU 渲染**：
- **预览模式**：12-30 分钟（角度间隔 10°，采样数 64）
- **生产模式**：2-4 小时（角度间隔 5°，采样数 256）

**硬件要求**：
- **最低配置**：4 核 CPU，16GB RAM，CPU 渲染
- **推荐配置**：8 核 CPU，NVIDIA RTX 3060+，32GB RAM，GPU 渲染
- **高性能配置**：16 核 CPU，NVIDIA RTX 4080/4090，64GB RAM，GPU 渲染

**注意**：使用 GPU 渲染可获得 5-20 倍速度提升，强烈推荐。

### 安装和使用

**安装方式**：
1. Blender > Edit > Preferences > Add-ons > Install
2. 选择 kiro_ies_generator.zip
3. 启用插件

**使用流程**：
1. 在 Blender 中准备灯具场景（模型 + 材质 + 光源）
2. 打开插件面板（3D 视图侧边栏 > IES Generator）
3. 配置采样参数和输出路径
4. 点击"生成 IES"按钮
5. 等待完成，获得 IES 文件

### 交付内容

1. **插件文件**（kiro_ies_generator.zip）
   - 完整的 Python 源代码
   - 模块化架构（4 个核心模块）
   - 完善的错误处理和日志

2. **文档**
   - 用户手册（中文）
   - 安装指南
   - 快速开始教程
   - 故障排除指南

3. **测试和示例**
   - 单元测试套件
   - 基准测试场景
   - 示例灯具场景文件

4. **兼容性**
   - Blender 3.6+
   - Blender 4.x
   - Windows / Linux / macOS

## 工作流程

1. **用户手动准备场景**（在 Blender 中）：
   - 导入灯具 3D 模型
   - 检查模型质量（封闭性、法线方向）
   - 在 Principled BSDF 中设置**基于物理的材质参数**（透射率、折射率、粗糙度、次表面散射等）
   - 在模型正确位置放置点光源或面光源
   - 设置**光源强度为总流明值**（例如 1800 lm）和光源尺寸

   **物理准确性**：为确保仿真结果与实验室测量一致，必须使用真实的物理参数：
   - 光源强度（流明 lm）来自 LED 规格书或通过功率 × 光效计算
   - 材质参数来自材料供应商数据（透射率、折射率、雾度）
   - 使用 Cycles Random Walk SSS 方法（最物理准确）
   
   **注意**：IES 文件只需要流明值，不需要瓦特值。

2. **插件执行核心功能**：
   - 基于 IESNA LM-63 C-Plane 坐标系进行球面采样
   - 使用 Cycles 渲染引擎计算每个采样点的光强
   - 将测量数据转换为 IES 格式
   - 输出符合标准的 .ies 文件

## 术语表

- **系统（System）**: Kiro IES Generator Blender 插件
- **用户（User）**: 操作插件的人员（灯光设计师、建筑师或工程师）
- **场景（Scene）**: 用户在 Blender 中手动准备的包含灯具模型、材质和光源的工作环境
- **采样器（Sampler）**: 插件中负责球面采样和光强测量的核心模块
- **IES生成器（IES_Generator）**: 负责将测量数据转换为 IES 格式并输出文件的模块
- **Cycles**: Blender 的基于物理的路径追踪渲染引擎
- **次表面散射（SSS）**: 光在半透明材质内部的穿透和散射
- **IES文件（IES_File）**: IESNA LM-63 标准光度学数据文件
- **C平面（C-Plane）**: IESNA 球面光分布测量坐标系
- **坎德拉（Candela）**: 光强度的 SI 单位（cd）
- **流明（Lumens）**: 光通量的 SI 单位（lm）
- **虚拟传感器（Virtual_Sensor）**: 插件在球面采样点放置的用于测量光强的虚拟相机

## 需求

### 需求 1：场景验证

**用户故事：** 作为用户，我希望插件在开始采样前验证场景设置，以便及早发现配置问题。

#### 验收标准

1. WHEN 用户启动插件时，THE 系统 SHALL 检查当前场景是否包含至少一个光源对象
2. WHEN 场景中没有光源时，THE 系统 SHALL 显示错误消息并提示用户添加光源
3. WHEN 场景中存在多个光源时，THE 系统 SHALL 允许用户多选光源进行综合测量
4. WHEN 用户选择光源后，THE 系统 SHALL 验证光源类型是否为点光源或面光源
5. WHEN 渲染引擎不是 Cycles 时，THE 系统 SHALL 提示用户切换到 Cycles 引擎
6. WHEN 用户选择多个光源时，THE 系统 SHALL 自动计算并显示光度中心位置

#### 补充说明：光源类型支持

插件支持两种光源类型：

**点光源（Point Light）**：
- 适用于：单个 LED 芯片、小型灯珠
- 参数：Strength（流明）、Radius（半径）

**面光源（Area Light）**：
- 适用于：灯管、LED 灯带、发光面板、灯片
- 参数：Strength（流明）、Shape（形状）、Size（尺寸）
- 形状选项：Rectangle（矩形）、Square（正方形）、Disk（圆形）

**设置示例**：
- 灯管：Rectangle，Size X = 长度，Size Y = 直径
- 面板灯：Square 或 Rectangle，Size = 面板尺寸
- LED 灯带：Rectangle，Size X = 长度，Size Y = 宽度

### 需求 2：采样参数配置

**用户故事：** 作为用户，我希望能够配置采样参数，以便在速度和精度之间取得平衡。

#### 验收标准

1. WHEN 用户打开插件面板时，THE 系统 SHALL 显示采样角度间隔设置（默认 10 度）
2. WHEN 用户打开插件面板时，THE 系统 SHALL 显示渲染采样数设置（默认 64）
3. WHEN 用户打开插件面板时，THE 系统 SHALL 显示测量距离设置（默认 5 米）
4. WHEN 用户修改参数时，THE 系统 SHALL 实时显示预计的采样点总数和估计时间
5. WHEN 用户输入无效参数时，THE 系统 SHALL 显示可接受的范围并恢复默认值

#### 补充说明：测量距离参数

**测量距离**定义了虚拟传感器距离光源的距离，决定了采样球面的半径。这个球面会自动包裹整个灯具。

- **推荐值**：灯具最大尺寸的 5-10 倍
- **示例**：
  - 小型灯具（直径 0.2m）→ 测量距离 1-2m
  - 中型灯具（直径 0.5m）→ 测量距离 2.5-5m
  - 大型灯具（直径 1.0m）→ 测量距离 5-10m
- **原理**：距离越远，越符合"远场"测量条件，与实验室标准一致
- **自动化**：用户只需设置距离值，插件自动计算所有采样点位置

### 需求 3：球面采样计算

**用户故事：** 作为用户，我希望插件按照 IESNA 标准进行球面采样，以便生成符合规范的 IES 文件。

#### 验收标准

1. WHEN 开始采样时，THE 采样器 SHALL 使用 IESNA LM-63 C-Plane 坐标系计算采样点位置
2. WHEN 计算垂直角度时，THE 采样器 SHALL 从 0 度（正下方）到 180 度（正上方）按指定间隔采样
3. WHEN 计算水平角度时，THE 采样器 SHALL 从 0 度到 360 度按指定间隔采样
4. WHEN 转换坐标时，THE 采样器 SHALL 正确处理 Blender Z-up 坐标系到 IES Y-up 坐标系的转换
5. FOR ALL 采样点，THE 采样器 SHALL 计算相对于光源位置的球面坐标

### 需求 4：虚拟传感器渲染

**用户故事：** 作为用户，我希望插件在每个采样点测量光强，以便获得完整的光分布数据。

#### 验收标准

1. WHEN 渲染采样点时，THE 采样器 SHALL 在该位置创建临时相机对象
2. WHEN 设置相机时，THE 采样器 SHALL 将相机朝向光源中心
3. WHEN 执行渲染时，THE 采样器 SHALL 使用用户配置的采样数进行 Cycles 渲染
4. WHEN 读取渲染结果时，THE 采样器 SHALL 从渲染图像中心像素提取亮度值
5. WHEN 渲染完成后，THE 采样器 SHALL 删除临时相机对象以保持场景清洁

### 需求 5：光强数据采集

**用户故事：** 作为用户，我希望插件准确记录每个方向的光强，以便生成可靠的 IES 数据。

#### 验收标准

1. WHEN 采集数据时，THE 采样器 SHALL 将每个采样点的亮度值存储到数据结构中
2. WHEN 存储数据时，THE 采样器 SHALL 关联亮度值与对应的垂直角度和水平角度
3. WHEN 渲染失败时，THE 采样器 SHALL 记录错误但继续处理剩余采样点
4. WHEN 所有采样完成时，THE 采样器 SHALL 验证数据完整性（无缺失值）
5. FOR ALL 采样数据，THE 采样器 SHALL 使用一致的单位（Blender 内部单位）

### 需求 6：单位转换与校准

**用户故事：** 作为用户，我希望插件将 Blender 渲染值转换为标准光度学单位，以便 IES 文件与行业工具兼容。

#### 验收标准

1. WHEN 用户指定光源流明值时，THE IES生成器 SHALL 使用该值进行校准计算
2. WHEN 计算校准因子时，THE IES生成器 SHALL 将所有采样点的亮度值求和
3. WHEN 应用校准时，THE IES生成器 SHALL 将每个亮度值转换为坎德拉（cd）
4. WHEN 校准因子异常时，THE IES生成器 SHALL 警告用户可能的场景配置问题
5. FOR ALL 数据点，THE IES生成器 SHALL 应用相同的校准因子以保持一致性

### 需求 7：IES 文件格式化

**用户故事：** 作为用户，我希望生成符合 IESNA LM-63-2002 标准的 IES 文件，以便在各种渲染引擎中使用。

#### 验收标准

1. WHEN 生成 IES 文件时，THE IES生成器 SHALL 创建符合 LM-63-2002 格式的文件头
2. WHEN 写入文件头时，THE IES生成器 SHALL 包含必要的元数据（流明值、角度数量等）
3. WHEN 写入角度列表时，THE IES生成器 SHALL 按升序输出垂直角度和水平角度
4. WHEN 写入光强数据时，THE IES生成器 SHALL 按照 C-Plane 格式组织坎德拉值
5. WHEN 格式化数值时，THE IES生成器 SHALL 使用适当的精度和对齐方式

### 需求 8：文件输出

**用户故事：** 作为用户，我希望将生成的 IES 文件和元数据保存到指定位置，以便在我的项目中使用。

#### 验收标准

1. WHEN 用户指定输出路径时，THE 系统 SHALL 将 IES 文件写入该位置
2. WHEN 输出目录不存在时，THE 系统 SHALL 创建必要的目录结构
3. WHEN 目标文件已存在时，THE 系统 SHALL 提示用户确认覆盖
4. WHEN 文件写入成功时，THE 系统 SHALL 显示确认消息和文件路径
5. WHEN 文件写入失败时，THE 系统 SHALL 显示错误原因并建议解决方案
6. WHEN 生成 IES 文件时，THE 系统 SHALL 同时生成配套的 JSON 元数据文件
7. WHEN 生成元数据文件时，THE 系统 SHALL 包含光度中心的世界坐标和相对坐标
8. WHEN 生成元数据文件时，THE 系统 SHALL 包含所有光源的位置和流明信息

#### 补充说明：元数据文件

**元数据文件内容**：

插件生成两个文件：
- `my_fixture.ies` - IES 光度学数据
- `my_fixture_metadata.json` - 光度中心和其他元数据

**元数据文件用途**：
- 记录光度中心的位置（世界坐标和相对坐标）
- 记录所有光源的信息
- 提供在渲染引擎中使用的说明
- 支持自动化工作流

**元数据文件格式**：
```json
{
  "fixture_name": "三 LED 吊灯",
  "photometric_center": {
    "world_coordinates": {"x": 0.0, "y": 0.0, "z": 1.5},
    "relative_to_fixture_origin": {"x": 0.0, "y": 0.0, "z": 0.1}
  },
  "light_sources": [...],
  "total_lumens": 1800,
  "usage_instructions": {...}
}
```

### 需求 9：进度反馈

**用户故事：** 作为用户，我希望在采样过程中看到实时进度，以便了解完成时间并确认插件正在工作。

#### 验收标准

1. WHEN 采样开始时，THE 系统 SHALL 显示进度条和采样点总数
2. WHILE 渲染采样点时，THE 系统 SHALL 更新进度条显示当前进度百分比
3. WHEN 每个采样点完成时，THE 系统 SHALL 更新状态文本显示当前角度
4. WHEN 用户想要取消时，THE 系统 SHALL 提供取消按钮并安全停止采样
5. WHEN 采样完成时，THE 系统 SHALL 显示总耗时和输出文件路径

### 需求 10：错误处理与日志

**用户故事：** 作为用户，我希望在出现问题时获得清晰的错误信息，以便理解并解决问题。

#### 验收标准

1. WHEN 发生错误时，THE 系统 SHALL 在 Blender 界面显示用户友好的错误消息
2. WHEN 错误发生时，THE 系统 SHALL 将详细错误信息记录到 Blender 控制台
3. WHEN 场景配置不正确时，THE 系统 SHALL 提供具体的修正建议
4. WHEN 渲染失败时，THE 系统 SHALL 指出失败的采样点位置
5. WHEN 发生意外异常时，THE 系统 SHALL 记录堆栈跟踪并安全清理临时对象

### 需求 11：Blender 插件集成

**用户故事：** 作为用户，我希望插件无缝集成到 Blender 界面中，以便方便地访问和使用。

#### 验收标准

1. WHEN 插件安装后，THE 系统 SHALL 在 3D 视图侧边栏添加"IES Generator"面板
2. WHEN 用户打开面板时，THE 系统 SHALL 显示所有配置选项和操作按钮
3. WHEN 插件运行时，THE 系统 SHALL 使用 Blender 的标准 UI 组件（按钮、滑块、文本框）
4. WHEN 插件卸载时，THE 系统 SHALL 清理所有注册的类和界面元素
5. WHEN 插件更新时，THE 系统 SHALL 保持与 Blender 3.6+ 和 4.x 版本的兼容性
6. WHEN 用户选择光源时，THE 系统 SHALL 在 UI 中实时显示计算的光度中心位置
7. WHEN 显示光度中心时，THE 系统 SHALL 同时显示世界坐标和相对坐标
8. WHEN 用户点击复制按钮时，THE 系统 SHALL 将光度中心坐标复制到剪贴板

#### 补充说明：光度中心显示

**UI 显示内容**：

```
IES Generator 面板：
┌─────────────────────────────────┐
│ 光源选择：                      │
│ ☑ LED_A  ☑ LED_B  ☑ LED_C      │
│                                 │
│ 计算的光度中心：                │
│ 世界坐标：(0.0, 0.0, 1.5)      │
│ 相对坐标：(0.0, 0.0, 0.1)      │
│ [复制世界坐标] [复制相对坐标]  │
│                                 │
│ 总流明：1800 lm                 │
└─────────────────────────────────┘
```

**功能说明**：
- 实时计算：选择光源后立即计算光度中心
- 世界坐标：光度中心在 Blender 世界空间中的位置
- 相对坐标：光度中心相对于灯具模型原点的偏移
- 复制功能：方便用户在渲染引擎中使用

### 需求 12：性能优化

**用户故事：** 作为用户，我希望插件高效运行，以便在合理时间内完成采样。

#### 验收标准

1. WHEN 存储采样数据时，THE 系统 SHALL 使用 NumPy 数组以提高处理速度
2. WHEN 渲染采样点时，THE 系统 SHALL 复用相机对象而不是每次创建新对象
3. WHEN 计算坐标转换时，THE 系统 SHALL 预计算三角函数值以减少重复计算
4. WHEN 用户选择低分辨率模式时，THE 系统 SHALL 在 5-10 分钟内完成采样
5. WHEN 系统空闲时，THE 系统 SHALL 释放不必要的内存和临时资源
