# 需求文档

## 简介

Kiro IES Generator 是一个基于 Blender Python API 构建的自动化工具，用于将 3D 灯具模型转换为符合 IESNA LM-63 标准的光度学文件（.ies）。该系统通过 Cycles 物理渲染引擎模拟半透明材质的光学特性（透射、散射、次表面散射），生成具有视觉真实感的 IES 文件，用于渲染应用。

## 术语表

- **系统（System）**: Kiro IES Generator 应用程序
- **输入管理器（Input_Manager）**: 负责导入和验证 3D 模型的模块
- **场景构建器（Scene_Builder）**: 负责构建包含光源和材质的 Blender 场景的模块
- **模拟引擎（Simulation_Engine）**: 负责配置 Cycles 渲染参数的模块
- **数据采集器（Data_Collector）**: 负责球面采样和亮度测量的模块
- **IES格式化器（IES_Formatter）**: 负责将数据转换为 IES 格式的模块
- **输出管理器（Output_Manager）**: 负责文件写入和验证的模块
- **用户（User）**: 操作 Kiro IES Generator 的人员（灯光设计师、建筑师或工程师）
- **网格（Mesh）**: 表示灯具的 3D 几何数据
- **Cycles**: Blender 的基于物理的路径追踪渲染引擎
- **次表面散射（SSS）**: 光在半透明材质内部的穿透和散射
- **IES文件（IES_File）**: IESNA LM-63 标准光度学数据文件
- **C平面（C-Plane）**: IESNA 球面光分布测量坐标系
- **坎德拉（Candela）**: 光强度的 SI 单位（cd）
- **流明（Lumens）**: 光通量的 SI 单位（lm）

## 需求

### 需求 1：3D 模型导入

**用户故事：** 作为灯光设计师，我希望能够导入常见格式的 3D 灯具模型，以便从现有设计文件生成光度学数据。

#### 验收标准

1. WHEN 用户提供 OBJ 文件路径时，THE 输入管理器 SHALL 将模型导入到 Blender 场景中
2. WHEN 用户提供 FBX 文件路径时，THE 输入管理器 SHALL 将模型导入到 Blender 场景中
3. WHEN 用户提供 STL 文件路径时，THE 输入管理器 SHALL 将模型导入到 Blender 场景中
4. WHEN 导入的模型包含无效几何体时，THE 输入管理器 SHALL 报告具体的验证错误
5. WHEN 导入的模型具有不一致的法线时，THE 输入管理器 SHALL 检测并报告该问题

### 需求 2：网格验证

**用户故事：** 作为用户，我希望系统验证我的 3D 模型几何体，以便确保准确的模拟结果。

#### 验收标准

1. WHEN 导入网格时，THE 输入管理器 SHALL 验证网格是否封闭（水密）
2. WHEN 网格具有非流形几何体时，THE 输入管理器 SHALL 报告具体的问题顶点或边
3. WHEN 网格具有翻转的法线时，THE 输入管理器 SHALL 检测并报告受影响的面
4. WHEN 网格通过所有验证检查时，THE 输入管理器 SHALL 确认模型已准备好进行模拟

### 需求 3：场景构建

**用户故事：** 作为用户，我希望系统自动设置模拟场景，以便我不需要手动配置 Blender 设置。

#### 验收标准

1. WHEN 场景构建开始时，THE 场景构建器 SHALL 清空默认的 Blender 场景
2. WHEN 创建光源时，THE 场景构建器 SHALL 将其放置在指定的 3D 坐标处
3. WHEN 配置光源时，THE 场景构建器 SHALL 将光通量设置为指定的流明值
4. WHEN 设置场景时，THE 场景构建器 SHALL 将场景单位配置为公制毫米
5. WHEN 应用材质时，THE 场景构建器 SHALL 使用指定参数创建 Principled BSDF 着色器节点

### 需求 4：材质模拟

**用户故事：** 作为灯光设计师，我希望模拟真实的材质属性，以便生成的 IES 文件准确表示光与我的灯具设计的交互方式。

#### 验收标准

1. WHEN 用户选择磨砂玻璃材质时，THE 场景构建器 SHALL 根据材质预设配置透射、粗糙度、IOR 和 SSS 参数
2. WHEN 用户选择乳白亚克力材质时，THE 场景构建器 SHALL 根据材质预设配置透射、粗糙度、IOR 和 SSS 参数
3. WHEN 用户提供自定义材质参数时，THE 场景构建器 SHALL 应用指定的透射、粗糙度、IOR 和 SSS 值
4. WHEN 应用 SSS 属性时，THE 场景构建器 SHALL 将次表面方法设置为 RANDOM_WALK
5. WHEN 材质参数无效时，THE 场景构建器 SHALL 报告验证错误并提供可接受的值范围

### 需求 5：渲染配置

**用户故事：** 作为用户，我希望系统配置最佳渲染设置，以便在无需手动设置的情况下获得准确的结果。

#### 验收标准

1. WHEN 初始化模拟时，THE 模拟引擎 SHALL 将渲染引擎设置为 Cycles
2. WHEN 配置预览模式时，THE 模拟引擎 SHALL 将采样数设置为 64
3. WHEN 配置生产模式时，THE 模拟引擎 SHALL 将采样数设置为 256 或更高
4. WHEN 启用去噪时，THE 模拟引擎 SHALL 配置 OpenImageDenoise 或 OptiX 去噪器
5. WHEN 存在 SSS 材质时，THE 模拟引擎 SHALL 启用去噪以减少噪点伪影

### 需求 6：球面采样

**用户故事：** 作为用户，我希望系统测量球面上的光分布，以便生成准确的光度学数据。

#### 验收标准

1. WHEN 执行球面采样时，THE 数据采集器 SHALL 使用 IESNA LM-63 C-Plane 坐标系计算传感器位置
2. WHEN 转换坐标时，THE 数据采集器 SHALL 从 Blender Z-up 转换到 IES Y-up 坐标系
3. WHEN 处于预览模式时，THE 数据采集器 SHALL 以 10 度角间隔进行采样
4. WHEN 处于生产模式时，THE 数据采集器 SHALL 以 5 度角间隔进行采样
5. WHEN 计算传感器位置时，THE 数据采集器 SHALL 将传感器放置在距光源指定距离处

### 需求 7：亮度测量

**用户故事：** 作为用户，我希望系统准确测量每个采样点的光强度，以便 IES 文件包含正确的光度学数据。

#### 验收标准

1. WHEN 渲染采样点时，THE 数据采集器 SHALL 在传感器位置执行 Cycles 渲染
2. WHEN 读取渲染输出时，THE 数据采集器 SHALL 从渲染图像中提取亮度值
3. WHEN 存储测量数据时，THE 数据采集器 SHALL 使用 NumPy 数组进行高效数据处理
4. WHEN 渲染失败时，THE 数据采集器 SHALL 报告错误并继续处理剩余样本
5. FOR ALL 采样点，THE 数据采集器 SHALL 存储测量的亮度及其对应的角坐标

### 需求 8：单位校准

**用户故事：** 作为用户，我希望系统将 Blender 单位转换为标准光度学单位，以便 IES 文件与行业工具兼容。

#### 验收标准

1. WHEN 转换亮度数据时，THE IES格式化器 SHALL 应用校准将 Blender 单位转换为坎德拉
2. WHEN 光源具有指定的流明值时，THE IES格式化器 SHALL 使用它进行校准计算
3. WHEN 校准因子无效时，THE IES格式化器 SHALL 报告错误并提供诊断信息
4. FOR ALL 测量数据点，THE IES格式化器 SHALL 应用一致的单位转换

### 需求 9：IES 文件生成

**用户故事：** 作为用户，我希望生成符合标准的 IES 文件，以便在渲染引擎和照明分析工具中使用。

#### 验收标准

1. WHEN 生成 IES 文件时，THE IES格式化器 SHALL 创建符合 IESNA LM-63-2002 格式的文件头
2. WHEN 写入角度数据时，THE IES格式化器 SHALL 以升序输出垂直角度
3. WHEN 写入角度数据时，THE IES格式化器 SHALL 以升序输出水平角度
4. WHEN 写入坎德拉值时，THE IES格式化器 SHALL 根据 LM-63-2002 规范格式化它们
5. WHEN IES 文件完成时，THE IES格式化器 SHALL 根据 LM-63-2002 标准要求验证输出

### 需求 10：文件输出

**用户故事：** 作为用户，我希望将生成的 IES 文件保存到磁盘，以便在我的照明项目中使用。

#### 验收标准

1. WHEN 用户指定输出路径时，THE 输出管理器 SHALL 将 IES 文件写入该位置
2. WHEN 输出目录不存在时，THE 输出管理器 SHALL 创建必要的目录
3. WHEN 输出路径已存在文件时，THE 输出管理器 SHALL 提示覆盖确认
4. WHEN 文件写入失败时，THE 输出管理器 SHALL 报告错误及具体失败原因
5. WHEN 文件成功写入时，THE 输出管理器 SHALL 确认输出路径和文件大小

### 需求 11：错误处理

**用户故事：** 作为用户，我希望在出现问题时获得清晰的错误消息，以便理解并修复问题。

#### 验收标准

1. WHEN 任何模块遇到错误时，THE 系统 SHALL 记录带有时间戳和模块名称的错误
2. WHEN 错误可恢复时，THE 系统 SHALL 提供建议的纠正措施
3. WHEN 错误是致命的时，THE 系统 SHALL 清理资源并优雅退出
4. WHEN 验证失败时，THE 系统 SHALL 一起报告所有验证错误，而不是在第一个错误处停止
5. IF 发生意外异常，THEN THE 系统 SHALL 记录完整的堆栈跟踪以供调试

### 需求 12：进度报告

**用户故事：** 作为用户，我希望在长时间运行的操作期间看到进度，以便知道系统正在工作并可以估计完成时间。

#### 验收标准

1. WHEN 球面采样开始时，THE 系统 SHALL 报告要渲染的采样点总数
2. WHILE 渲染采样点时，THE 系统 SHALL 在每个完成的渲染后更新进度
3. WHEN 每个主要阶段完成时，THE 系统 SHALL 报告阶段名称和经过的时间
4. WHEN 处于具有许多样本的生产模式时，THE 系统 SHALL 提供估计的剩余时间
5. WHEN 所有操作完成时，THE 系统 SHALL 报告总执行时间

### 需求 13：材质预设管理

**用户故事：** 作为用户，我希望使用预定义的材质预设，以便快速应用真实的材质属性而无需手动调整参数。

#### 验收标准

1. WHEN 系统初始化时，THE 场景构建器 SHALL 从配置文件加载材质预设
2. WHEN 用户请求可用预设时，THE 场景构建器 SHALL 返回预设名称和描述列表
3. WHEN 用户按名称选择预设时，THE 场景构建器 SHALL 应用相应的材质参数
4. WHEN 配置文件丢失或无效时，THE 场景构建器 SHALL 使用内置默认预设
5. WHERE 定义了自定义预设，THE 场景构建器 SHALL 在应用之前验证参数范围

### 需求 14：坐标系转换

**用户故事：** 作为开发人员，我希望准确的坐标系转换，以便 IES 文件正确表示光分布。

#### 验收标准

1. WHEN 在 Blender 中计算传感器位置时，THE 数据采集器 SHALL 使用 Z-up 右手坐标系
2. WHEN 写入 IES 格式时，THE IES格式化器 SHALL 转换为 Y-up 坐标系
3. FOR ALL 角度测量，THE 系统 SHALL 保持一致的坐标系约定
4. WHEN 在坐标系之间转换时，THE 系统 SHALL 保持光分布的几何关系

### 需求 15：渲染性能模式

**用户故事：** 作为用户，我希望在快速预览和高质量生产模式之间进行选择，以便在设计期间快速迭代并在需要时生成最终输出。

#### 验收标准

1. WHEN 选择预览模式时，THE 系统 SHALL 使用 10 度角间隔和每次渲染 64 个样本
2. WHEN 选择生产模式时，THE 系统 SHALL 使用 5 度角间隔和每次渲染 256+ 个样本
3. WHEN 预览模式完成时，THE 系统 SHALL 报告生产模式的估计时间
4. WHERE 提供了自定义采样参数，THE 系统 SHALL 验证并应用它们
5. WHEN 模式参数无效时，THE 系统 SHALL 报告可接受的范围并使用默认值
